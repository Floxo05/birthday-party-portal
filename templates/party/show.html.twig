{% extends 'base.html.twig' %}

{% block title %}{{ party.title }}{% endblock %}

{% block body %}
    <section class="mb-2 pb-1 border-bottom">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
                <h1 class="mb-2">{{ party.title }}</h1>
                <p class="text-muted">{{ party.partyDate|date('d.m.Y') }}</p>
            </div>

            <div class="mt-2 mt-lg-0">
                {% include 'party/_status.html.twig' with { 'party': party, 'currentUser': currentUser } %}
            </div>
        </div>
    </section>

    <section class="mb-2 pb-2 border-bottom">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h4 m-0 text-primary">Nachrichten</h2>
            {% set membership = party.partyMembers|filter(m => m.user == currentUser)|first %}
            {% if membership and membership.role == 'Host' %}
                <a href="{{ path('chat_rooms_list', {id: party.id}) }}" class="btn btn-sm btn-outline-secondary">Alle Chats</a>
            {% endif %}
        </div>

        {% include 'party/_news_summary.html.twig' with { 'news': news, 'statusMap': statusMap } %}

        {% if news|length > 0 %}
            <a href="{{ path('party_news_list', {id: party.id}) }}" class="btn btn-link mt-3">
                ➔ Alle Nachrichten anzeigen
            </a>
        {% endif %}
    </section>

    <section class="mb-2">
        <h2 class="h4 mb-3 text-primary">Aktionen</h2>

        {% include 'party/_actions.html.twig' %}
    </section>

    {% if popupNews is not empty %}
        <div id="popupNewsModal" class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true"
             style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content shadow-lg">
                    <div class="modal-header">
                        <h5 class="modal-title">Wichtige Nachrichten</h5>
                        <button type="button" class="btn-close" aria-label="Schließen" data-close-popup></button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow: auto;">
                        {% for popup in popupNews %}
                            <div class="alert alert-warning mb-3">
                                <div class="text-break">{{ popup.text|raw|nl2br }}</div>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <small class="text-muted">{{ popup.createdAt|date('d.m.Y H:i') }}</small>
                                    <a href="{{ path('party_news_detail', {id: popup.id}) }}"
                                       class="btn btn-sm btn-primary">Details ansehen</a>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">Keine Nachrichten vorhanden.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <script>
            (function () {
                var modal = document.getElementById('popupNewsModal');
                if (!modal) return;
                var closeBtn = modal.querySelector('[data-close-popup]');
                var dismiss = function () {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                };
                if (closeBtn) {
                    closeBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        dismiss();
                    });
                }
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        dismiss();
                    }
                });
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' || e.key === 'Esc') {
                        dismiss();
                    }
                }, {once: true});
            })();
        </script>
    {% endif %}
{% endblock %}
